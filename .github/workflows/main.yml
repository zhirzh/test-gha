# fastlane build platform:android

on:
  issue_comment:
    types:
      - created
      - edited

jobs:
  test:
    # if: |
    #   github.event.issue.pull_request &&
    #   startsWith(github.event.comment.body, '/fastlane')

    runs-on: ubuntu-latest

    steps:
      - name: Start SSH
        uses: mxschmitt/action-tmate@v3

      - name: test
        env:
          GH_TOKEN: ${{ github.token }}
          PR_URL: ${{ github.event.issue }}
          PR_NO: ${{ github.event.issue.number.html_url }}
        run: |
          echo "BRANCH=$(gh pr view --json headRefName --jq .headRefName $PR_URL)"
          echo "BRANCH=$(gh pr view --json headRefName --jq .headRefName $PR_NO)"

      - id: get-pr-branch
        env:
          GH_TOKEN: ${{ github.token }}
          PR_URL: ${{ github.event.issue.html_url }}
        run: |
          echo "BRANCH=$(gh pr view --json headRefName --jq .headRefName $PR_URL)" >> "$GITHUB_OUTPUT"

      - name: Split the string
        uses: actions/github-script@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = context.payload.comment.body;
            const parts = comment.split(' ');
            console.log(parts);

      - uses: circleci-public/trigger-circleci-pipeline-action@v1.2.0
        env:
          CCI_TOKEN: ${{ secrets.CCI_TOKEN_SZ }}
        with:
          target-branch: ${{ steps.get-pr-branch.outputs.BRANCH }}
          GHA_Meta: ${{ github.event.comment.body }}
